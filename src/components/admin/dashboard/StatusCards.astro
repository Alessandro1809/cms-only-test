---
const API_URL = import.meta.env.PUBLIC_API_URL || 'https://blog-api-rrttqa.fly.dev/api/v1';

// Helper para fetch con timeout
async function fetchWithTimeout(url: string, timeout = 5000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

// Función para obtener estadísticas de posts
async function fetchPostStats() {
    try {
        // Obtener posts publicados
        const publishedResponse = await fetchWithTimeout(
            `${API_URL}/posts?status=PUBLISHED`,
            5000
        );
        if (!publishedResponse.ok) {
            console.error(`Failed to fetch published posts: ${publishedResponse.status}`);
            return { published: 0, draft: 0 };
        }
        const publishedData = await publishedResponse.json();
        const publishedCount = publishedData.total || 0;

        // Obtener posts en borrador
        const draftResponse = await fetchWithTimeout(`${API_URL}/posts?status=DRAFT`, 5000);
        if (!draftResponse.ok) {
            console.error(`Failed to fetch draft posts: ${draftResponse.status}`);
            return { published: publishedCount, draft: 0 };
        }
        const draftData = await draftResponse.json();
        const draftCount = draftData.total || 0;

        return {
            published: publishedCount,
            draft: draftCount,
        };
    } catch (error) {
        console.error("Error fetching post stats:", error);
        return {
            published: 0,
            draft: 0,
        };
    }
}

// Función para obtener total de vistas
async function fetchTotalViews() {
    try {
        const response = await fetchWithTimeout(`${API_URL}/posts/stats/views`, 5000);
        if (!response.ok) {
            return 0;
        }
        const data = await response.json();
        return data.totalViews || 0;
    } catch (error) {
        console.error("Error fetching total views:", error);
        return 0;
    }
}

// Obtener estadísticas con timeout general
let postStats = { published: 0, draft: 0 };
let totalViews = 0;

try {
    const statsPromise = Promise.race([
        fetchPostStats(),
        new Promise<{ published: number; draft: number }>((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), 8000)
        )
    ]);
    
    const viewsPromise = Promise.race([
        fetchTotalViews(),
        new Promise<number>((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), 8000)
        )
    ]);

    [postStats, totalViews] = await Promise.all([
        statsPromise.catch(() => ({ published: 0, draft: 0 })),
        viewsPromise.catch(() => 0)
    ]);
} catch (error) {
    console.error("Error loading dashboard stats:", error);
}
---

<section class="container mx-auto max-w-12xl mt-10">
    <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
    >
        <article
            class="flex flex-col gap-2 rounded-lg glass p-4 border border-white/5"
        >
            <h3 class="font-semibold text-gray-400">Cantidad de vistas</h3>
            <p class="text-3xl font-bold text-[var(--color-secondary)]">
                {totalViews.toLocaleString()}
            </p>
        </article>
        <article
            class="flex flex-col gap-2 rounded-lg glass p-4 border border-white/5"
        >
            <h3 class="font-semibold text-gray-400">
                Cantidad de suscriptores
            </h3>
            <p class="text-3xl font-bold text-[var(--color-secondary)]">32</p>
        </article>
        <article
            class="flex flex-col gap-2 rounded-lg glass p-4 border border-white/5"
        >
            <h3 class="font-semibold text-gray-400">Posts publicados</h3>
            <p class="text-3xl font-bold text-[var(--color-secondary)]">
                {postStats.published}
            </p>
        </article>
        <article
            class="flex flex-col gap-2 rounded-lg glass p-4 border border-white/5"
        >
            <h3 class="font-semibold text-gray-400">Posts en borrador</h3>
            <p class="text-3xl font-bold text-[var(--color-secondary)]">
                {postStats.draft}
            </p>
        </article>
    </div>
</section>
